# Database Migrations

This directory contains SQLite migrations for the Cloudflare D1 database.

## Migration Ownership

The **web app** is the migration owner. All database schema changes are:
1. Generated in `packages/core` via Drizzle Kit
2. Output to this directory (`apps/web/migrations/`)
3. Applied via wrangler commands from the web app

The API app simply binds to the same database without managing migrations.

## Current Migration

- `0000_crazy_selene.sql` - Initial schema with 21 tables (326 lines)

## Workflow

### Local Development

```bash
# 1. Make schema changes in packages/core/src/drizzle/schema/*.ts

# 2. Generate Better Auth schema (if auth changes)
pnpm db:auth:generate

# 3. Generate migration SQL
pnpm db:generate

# 4. Apply migrations locally
pnpm db:migrate:local

# 5. Test locally
pnpm dev:web
```

### Production Deployment

```bash
# Apply migrations to production
pnpm db:migrate:remote

# Deploy apps
pnpm deploy:web
pnpm deploy:api
```

## Migration Files

- Format: `NNNN_description.sql`
- Generated by Drizzle Kit from TypeScript schema
- Applied in order by wrangler
- Never modify existing migrations - create new ones

## Commands

- `pnpm db:generate` - Generate new migration from schema changes
- `pnpm db:migrate:local` - Apply migrations to local D1
- `pnpm db:migrate:remote` - Apply migrations to production D1
- `pnpm db:setup` - Complete setup: generate auth + migrations + apply locally

## Database Configuration

The D1 database binding is configured in `wrangler.jsonc`:
- `database_name`: onlydonations-db
- `database_id`: YOUR_DATABASE_ID (update this with your actual D1 database ID)
- `migrations_dir`: migrations

## Local D1 Database

Wrangler creates a local SQLite database at:
`.wrangler/state/v3/d1/miniflare-D1DatabaseObject/<hash>.sqlite`

The hash changes based on your database ID, so our Drizzle config dynamically finds it.

## Tables Created

### Auth Tables (7)
- auth_user, auth_session, auth_account, auth_verification
- organization, member, invitation

### Application Tables (14)
- campaign, campaign_update, category
- content_moderation, countries, currencies
- donation, payment_transaction, refund
- user_kyc_status, verification_job, smile_webhook_event
- webhook_event, withdrawal_account
